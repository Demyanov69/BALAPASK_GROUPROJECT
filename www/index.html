<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nim</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root {
      --bg1: #fff7fb;
      --bg2: #ffeef6;
      --accent: #ff6fa3;
      --accent-2: #ff9abf;
      --muted: #6b6b6b;
      --shadow: 0 8px 30px rgba(213, 78, 131, 0.08);
    }

    html,
    body {
      height: 100%;
      margin: 0;
      font-family: Inter, system-ui, Arial;
    }

    body {
      background: radial-gradient(1200px 600px at 10% 10%, rgba(255, 140, 186, 0.08), transparent), linear-gradient(180deg, var(--bg1), var(--bg2));
      color: #222;
      -webkit-font-smoothing: antialiased;
    }

    .wrap {
      max-width: 1100px;
      margin: 28px auto;
      padding: 20px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 18px;
    }

    @media(max-width:980px) {
      .grid {
        grid-template-columns: 1fr
      }
    }

    .card {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.96), rgba(255, 255, 255, 0.92));
      border-radius: 14px;
      padding: 18px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255, 111, 140, 0.06)
    }

    .controls-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap
    }

    input[type="number"],
    select {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.06)
    }

    .btn-pink {
      background: linear-gradient(180deg, var(--accent-2), var(--accent));
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(0, 0, 0, 0.06);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer
    }

    .small-muted {
      color: var(--muted);
      font-size: 0.9rem
    }

    #sticks {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px
    }

    .group {
      display: inline-flex;
      gap: 6px;
      padding: 6px 8px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.92);
      align-items: center
    }

    .match {
      width: 18px;
      height: 70px;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      transform-origin: center bottom;
      transition: transform 420ms cubic-bezier(.2, .9, .25, 1), opacity 420ms ease;
      will-change: transform, opacity;
      user-select: none;
      -webkit-user-drag: none;
    }

    .match svg {
      width: 18px;
      height: 70px;
      display: block;
    }

    .match.removed {
      transform: translateY(36px) rotate(-40deg) scale(0.65);
      opacity: 0;
    }

    .match.burning .match-head {
      transition: fill 420ms linear;
      fill: #ffb84d !important;
      filter: drop-shadow(0 6px 8px rgba(255, 140, 80, 0.35));
    }

    .match.burning .match-tip {
      transition: fill 420ms linear;
      fill: #fffbdd !important;
    }

    .match.burned .match-head {
      fill: #3a2a2a !important;
      opacity: 0.9;
      filter: none;
    }

    .match.burned .match-tip {
      fill: #4b3a3a !important;
    }

    #log {
      max-height: 480px;
      overflow: auto;
      padding: 10px;
      border-radius: 10px;
      background: linear-gradient(180deg, #fff, #fff);
      border: 1px solid rgba(0, 0, 0, 0.03)
    }

    .log-entry {
      padding: 8px;
      border-radius: 8px;
      margin-bottom: 10px;
      background: linear-gradient(180deg, #fff, #fff);
      box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.02)
    }

    #overlayDark {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9996;
      transition: background .45s
    }

    #overlayDark.active {
      background: rgba(0, 0, 0, 0.36);
    }

    canvas.fx,
    canvas.rain {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9997;
    }

    .shake {
      animation: screenShake .65s ease;
    }

    @keyframes screenShake {
      0% {
        transform: none
      }

      20% {
        transform: translate(-8px, 5px) rotate(-0.6deg)
      }

      40% {
        transform: translate(6px, -4px) rotate(0.6deg)
      }

      60% {
        transform: translate(-3px, 2px)
      }

      80% {
        transform: translate(3px, -2px)
      }

      100% {
        transform: none
      }
    }

    .muted {
      color: var(--muted);
      font-size: 0.9rem;
      margin-top: 8px;
      display: block
    }
  </style>
</head>

<body>
  <div id="overlayDark"></div>
  <canvas id="fxCanvas" class="fx" aria-hidden="true"></canvas>
  <canvas id="rainCanvas" class="rain" aria-hidden="true"></canvas>

  <div class="wrap">
    <header style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div>
        <h1 style="margin:0;color:#6b0f4a">Nim</h1>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <div class="controls-row">
          <label class="small-muted">–ù–∞—á–∞–ª—å–Ω—ã–µ —Å–ø–∏—á–∫–∏</label>
          <input id="init" type="number" value="13" />
          <label class="small-muted">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
          <select id="difficulty">
            <option value="easy">Easy</option>
            <option value="medium" selected>Medium</option>
            <option value="hard">Hard</option>
          </select>

          <button id="start" class="btn-pink">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
          <button id="reset" class="btn-ghost" style="display:none">–ó–∞–Ω–æ–≤–æ</button>

          <div style="margin-left:auto;text-align:right">
          </div>
        </div>

        <hr style="margin:12px 0">

        <div><small class="small-muted">C–ø–∏—á–∫–∏ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã –ø–æ 4</small></div>
        <div id="sticks" style="margin-top:10px"></div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn-pink" data-take="1">–í–∑—è—Ç—å 1</button>
          <button class="btn-pink" data-take="2">–í–∑—è—Ç—å 2</button>
          <button class="btn-pink" data-take="3">–í–∑—è—Ç—å 3</button>
          <div style="margin-left:auto;align-self:center"><span id="countBadge"
              style="background:#fff;padding:6px 10px;border-radius:10px;font-weight:600">–û—Å—Ç–∞–ª–æ—Å—å: ‚Äî</span></div>
        </div>

        <div style="margin-top:10px"><small id="rangeText" class="small-muted">–ú–æ–∂–Ω–æ –≤–∑—è—Ç—å: ‚Äî</small></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">–õ–æ–≥</h3>
          <div><button id="refresh" class="btn-ghost">–û–±–Ω–æ–≤–∏—Ç—å</button></div>
        </div>
        <div id="log" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const $ = id => document.getElementById(id);
      const appendLog = (t, m) => { const log = $('log'); if (!log) return; const e = document.createElement('div'); e.className = 'log-entry'; e.innerHTML = `<div class="small text-muted">${new Date().toLocaleTimeString()} ‚Ä¢ <strong>${t}</strong></div><div>${String(m)}</div>`; log.prepend(e); };
      const startBtn = $('start'), resetBtn = $('reset'), initIn = $('init'), diff = $('difficulty');
      const sticksDiv = $('sticks'), countBadge = $('countBadge'), rangeText = $('rangeText');
      const refreshBtn = $('refresh'), mainCard = document.querySelector('.card');
      const fxCanvas = $('fxCanvas'), rainCanvas = $('rainCanvas');
      const fxCtx = fxCanvas ? fxCanvas.getContext('2d') : null;
      const rainCtx = rainCanvas ? rainCanvas.getContext('2d') : null;
      const overlayDark = $('overlayDark');

      function resizeCanvases() { if (fxCanvas) { fxCanvas.width = innerWidth; fxCanvas.height = innerHeight } if (rainCanvas) { rainCanvas.width = innerWidth; rainCanvas.height = innerHeight } }
      window.addEventListener('resize', resizeCanvases); resizeCanvases();

      const sparks = [];
      let sparksRunning = false;
      function spawnSparksAtRect(rect, count = 18) {
        if (!fxCtx || !rect) return;
        const cx = rect.left + rect.width / 2 + window.scrollX;
        const cy = rect.top + rect.height * 0.25 + window.scrollY;
        for (let i = 0; i < count; i++) {
          const ang = Math.random() * Math.PI * 2;
          const speed = 1 + Math.random() * 4;
          sparks.push({ x: cx, y: cy, vx: Math.cos(ang) * speed, vy: Math.sin(ang) * speed - 2 - Math.random() * 1.5, life: 24 + Math.random() * 18, size: 1 + Math.random() * 3, color: ['#ffd36b', '#ffb84d', '#fff2b0'][Math.floor(Math.random() * 3)] });
        }
        if (!sparksRunning) runSparksLoop();
      }
      function runSparksLoop() {
        if (!fxCtx) return;
        sparksRunning = true;
        (function loop() {
          fxCtx.clearRect(0, 0, fxCanvas.width, fxCanvas.height);
          for (let i = sparks.length - 1; i >= 0; i--) {
            const p = sparks[i];
            p.vy += 0.12;
            p.x += p.vx; p.y += p.vy; p.life -= 1;
            fxCtx.globalAlpha = Math.max(0, p.life / 40);
            fxCtx.fillStyle = p.color;
            fxCtx.beginPath(); fxCtx.ellipse(p.x, p.y, p.size, p.size, 0, 0, Math.PI * 2); fxCtx.fill();
          }
          for (let i = sparks.length - 1; i >= 0; i--) if (sparks[i].life <= 0) sparks.splice(i, 1);
          if (sparks.length > 0) requestAnimationFrame(loop); else { fxCtx.clearRect(0, 0, fxCanvas.width, fxCanvas.height); sparksRunning = false; }
        })();
      }

      function createMatchElement() {
        const wrapper = document.createElement('div'); wrapper.className = 'match';
        wrapper.innerHTML = `
        <svg viewBox="0 0 24 80" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" focusable="false">
          <rect x="9" y="22" width="6" height="50" rx="3" fill="#d8b89a"/>
          <ellipse class="match-head" cx="12" cy="14" rx="8" ry="12" fill="#ff7b7b"/>
          <ellipse class="match-highlight" cx="12" cy="13" rx="4" ry="6" fill="#ffdada" opacity="0.6"/>
          <ellipse class="match-tip" cx="12" cy="9" rx="3.2" ry="3.6" fill="#7f1f1f" opacity="0.95"/>
        </svg>`;
        wrapper.setAttribute('aria-hidden', 'true');
        return wrapper;
      }

      function renderSticks(n) {
        if (!sticksDiv) return;
        sticksDiv.innerHTML = '';
        let rem = n;
        while (rem > 0) {
          const group = document.createElement('div'); group.className = 'group';
          const inGroup = Math.min(4, rem);
          for (let i = 0; i < inGroup; i++) group.appendChild(createMatchElement());
          sticksDiv.appendChild(group);
          rem -= inGroup;
        }
        if (n === 0) sticksDiv.textContent = '[–ø—É—Å—Ç–æ]';
      }

      function animateRemove(oldCount, newCount) {
        if (!sticksDiv) return Promise.resolve();
        const removed = Math.max(0, oldCount - newCount);
        if (removed <= 0) return Promise.resolve();
        const matches = Array.from(sticksDiv.querySelectorAll('.match'));
        const toRemove = matches.slice(-removed);
        const BURN_MS = 420;
        return new Promise(resolve => {
          toRemove.forEach((el, i) => {
            const delay = i * 100;
            setTimeout(() => {
              el.classList.add('burning');
              const rect = el.getBoundingClientRect();
              spawnSparksAtRect(rect, 14);
              setTimeout(() => {
                el.classList.remove('burning');
                el.classList.add('burned');
                setTimeout(() => el.classList.add('removed'), 70);
              }, BURN_MS);
            }, delay);
          });
          const total = (toRemove.length - 1) * 100 + BURN_MS + 520;
          setTimeout(() => { renderSticks(newCount); resolve(); }, total);
        });
      }

      const palette = ['#ff6fa3', '#ff9abf', '#ffd1e8', '#ff80ab', '#ffd08a', '#ffe07b', '#9be3ff', '#8ae6b8', '#c4a7ff'];
      function launchConfetti(cnt = 2400) {
        if (!fxCtx) return;
        const parts = [];
        for (let i = 0; i < cnt; i++) parts.push({ x: fxCanvas.width / 2 + (Math.random() - 0.5) * 300, y: fxCanvas.height * 0.25 + (Math.random() - 0.5) * 120, vx: (Math.random() - 0.5) * 10, vy: (Math.random() * -6) - 2, life: 80 + Math.random() * 140, size: 6 + Math.random() * 10, color: palette[Math.floor(Math.random() * palette.length)], shape: Math.random() < 0.5 ? 'rect' : 'circle' });
        let t = 0; function step() {
          fxCtx.clearRect(0, 0, fxCanvas.width, fxCanvas.height);
          parts.forEach(p => {
            p.vy += 0.22;
            p.x += p.vx;
            p.y += p.vy;
            p.life -= 1;
            fxCtx.globalAlpha = Math.max(0, p.life / 160);
            fxCtx.fillStyle = p.color;
            if (p.shape === 'rect') fxCtx.fillRect(p.x, p.y, p.size, p.size * 0.6);
            else {
              fxCtx.beginPath(); fxCtx.ellipse(p.x, p.y, p.size / 2, p.size / 2, 0, 0, Math.PI * 2);
              fxCtx.fill();
            }
          });
          for (let i = parts.length - 1; i >= 0; i--) if (parts[i].life <= 0) parts.splice(i, 1); if (parts.length > 0 && t < 400) {
            t++; requestAnimationFrame(step);

          } else fxCtx.clearRect(0, 0, fxCanvas.width, fxCanvas.height);
        } step();
      }

      function launchRain(duration = 300) {
        if (!rainCtx) return;
        overlayDark.classList.add('active');
        mainCard && mainCard.classList.add('shake');
        setTimeout(() => mainCard && mainCard.classList.remove('shake'), 700);
        const W = rainCanvas.width, H = rainCanvas.height;
        const parts = []; 
        for (let i = 0; i < 2200; i++) parts.push({ x: Math.random() * W, y: Math.random() * -H, vy: 4 + Math.random() * 5, len: 12 + Math.random() * 18, alpha: 0.12 + Math.random() * 0.2, color: (Math.random() < 0.6) ? 'rgba(30,10,20,0.9)' : 'rgba(70,20,40,0.9)' });
        let t = 0; function step() {
          rainCtx.clearRect(0, 0, W, H);
          rainCtx.lineWidth = 1.8;
          parts.forEach(p => {
            rainCtx.beginPath();
            rainCtx.strokeStyle = p.color;
            rainCtx.globalAlpha = p.alpha;
            rainCtx.moveTo(p.x, p.y);
            rainCtx.lineTo(p.x, p.y + p.len);
            rainCtx.stroke(); p.y += p.vy;
            if (p.y > H + 30) p.y = -20 - Math.random() * H * 0.6;
          });
          rainCtx.globalAlpha = 1; t++;
          if (t < duration) requestAnimationFrame(step);
          else {
            rainCtx.clearRect(0, 0, W, H);
            overlayDark.classList.remove('active');
          }
        }
        step();
      }

      function performVictoryAnimation() {
        launchConfetti(2400);
      }
      function performLossAnimation() {
        launchRain(320);
        mainCard && mainCard.classList.add('shake'); 
        setTimeout(() => mainCard && mainCard.classList.remove('shake'), 700);
      }
      window.performVictoryAnimation = performVictoryAnimation;
      window.performLossAnimation = performLossAnimation;

      let currentSticks = 0, currentTurn = null;
      function setState(n, turn) {
        currentSticks = n;
        currentTurn = turn;
        if (countBadge) countBadge.textContent = '–û—Å—Ç–∞–ª–æ—Å—å: ' + n;
        if (rangeText) rangeText.textContent = '–ú–æ–∂–Ω–æ –≤–∑—è—Ç—å: 1‚Äì' + Math.min(3, n);
        document.querySelectorAll('[data-take]').forEach(b => {
          if (!b) return;
          const t = parseInt(b.dataset.take, 10);
          b.disabled = (t > Math.min(3, n)) || (n === 0) || (turn !== 'player');
        });
      }
      async function postJson(path, body) {
        try {
          const resp = await fetch(path, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          const j = await resp.json();
          return j;
        } catch (err) {
          appendLog('–°–∏—Å—Ç–µ–º–∞', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + (err && err.message ? err.message : String(err)));
          return {
            ok: false, error: String(err)

          };
        }
      }

      startBtn && startBtn.addEventListener('click', async () => {
        const sticks = Math.max(1, parseInt(initIn.value) || 13);
        const difficulty = diff ? diff.value : 'hard';
        startBtn.disabled = true;
        appendLog('–°–∏—Å—Ç–µ–º–∞', '–ó–∞–ø—É—Å–∫: ' + sticks + ' —Å–ø–∏—á–µ–∫, —É—Ä–æ–≤–µ–Ω—å ' + difficulty);
        const j = await postJson('/start', { sticks, difficulty });
        if (!j.ok) {
          appendLog('–°–∏—Å—Ç–µ–º–∞', '–û—à–∏–±–∫–∞: ' + (j.error || 'unknown'));
          startBtn.disabled = false; return;
        }
        renderSticks(j.sticks || 0);
        setState(j.sticks || 0, j.turn);
        appendLog('–°–∏—Å—Ç–µ–º–∞', '–ò–≥—Ä–∞ –≥–æ—Ç–æ–≤–∞. –í–∞—à —Ö–æ–¥.');
        startBtn.style.display = 'none';
        resetBtn && (resetBtn.style.display = 'inline-block');
      });
      resetBtn && resetBtn.addEventListener('click', () => location.reload());

      document.querySelectorAll('[data-take]').forEach(btn => {
        if (!btn) return;
        btn.addEventListener('click', async () => {
          const take = parseInt(btn.dataset.take, 10);
          if (currentTurn !== 'player') {
            appendLog('–°–∏—Å—Ç–µ–º–∞', '–°–µ–π—á–∞—Å –Ω–µ –≤–∞—à —Ö–æ–¥.');
            return;
          }
          appendLog('–ò–≥—Ä–æ–∫', '–ë–µ—Ä—ë—Ç ' + take);
          const before = currentSticks;
          const j = await postJson('/player_move', { take });
          if (!j.ok) {
            appendLog('–°–∏—Å—Ç–µ–º–∞', '–û—à–∏–±–∫–∞: ' + (j.error || 'unknown'));
            setState(before, 'player');
            return;
          }
          if (j.winner === 'player') {
            await animateRemove(before, 0);
            setState(0, null);
            appendLog('–ò–≥—Ä–æ–∫', '–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏! üéâ');
            performVictoryAnimation();
            return;
          }
          const afterPlayer = before - take;
          await animateRemove(before, afterPlayer);
          appendLog('–ë–æ—Ç', '–ë–µ—Ä—ë—Ç ' + j.botMove + '. ' + (j.botExplanation || ''));
          const after = j.sticks || 0;
          await animateRemove(afterPlayer, after);
          setState(after, 'player');
          if (j.winner === 'bot') {
            appendLog('–°–∏—Å—Ç–µ–º–∞', '–ë–æ—Ç –≤—ã–∏–≥—Ä–∞–ª. –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏.');
            performLossAnimation();
          }
        });
      });

      refreshBtn && refreshBtn.addEventListener('click', async () => { 
        try { const r = await fetch('/state'); 
        const j = await r.json(); 
        if (!j.ok) { 
          appendLog('–°–∏—Å—Ç–µ–º–∞', '–ò–≥—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞'); 
          return; 
        } 
        renderSticks(j.sticks || 0); 
        setState(j.sticks || 0, j.turn); 
        appendLog('–°–∏—Å—Ç–µ–º–∞', '–°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ'); 
      } 
      catch (e) { 
        appendLog('–°–∏—Å—Ç–µ–º–∞', '–û—à–∏–±–∫–∞: ' + (e && e.message ? e.message : String(e))); 
      } 
    });

      renderSticks(0); 
      setState(0, null); 
      appendLog('–°–∏—Å—Ç–µ–º–∞', '–ì–æ—Ç–æ–≤–æ. –í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å –∏ –Ω–∞–∂–º–∏—Ç–µ –ó–∞–ø—É—Å—Ç–∏—Ç—å.');
      window.addEventListener('error', ev => { 
        appendLog('JS Error', ev && ev.message ? ev.message : String(ev)); console.error(ev); 
      });

    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
