<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nim ‚Äî –ò–≥—Ä–∞</title>

  <!-- –†—É–±—Ä–∏–∫–∞ —à—Ä–∏—Ñ—Ç–∞ (–∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å—Å—ã–ª–∫–∞ –Ω–∞ Google Fonts) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1: #fff0f6;
      --bg2: #ffe6f0;
      --accent1: #ff6fa3;
      --accent2: #ff9abf;
      --card: #ffffff;
      --muted: #6b6b6b;
      --glass: rgba(255,255,255,0.6);
      --success: #28a745;
      --danger: #dc3545;
      --shadow: 0 6px 30px rgba(255,105,145,0.12);
    }

    html,body{
      height:100%;
      margin:0;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
      color:#222;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .container{
      max-width: 980px;
      margin: 36px auto;
      padding: 24px;
    }

    header{
      text-align:center;
      margin-bottom: 18px;
    }

    header h1{
      margin:0;
      font-weight:700;
      letter-spacing:-0.4px;
      color: #2a2a2a;
    }
    header p{ margin:8px 0 0; color:var(--muted); }

    .grid{
      display:grid;
      grid-template-columns: 1fr 380px;
      gap:20px;
      align-items:start;
    }

    /* Card */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.82));
      border-radius:16px;
      padding:18px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,111,140,0.08);
    }

    /* Game area */
    #gameHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .controls-row{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:12px;
    }

    input[type="number"]{
      width:100px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,0.08);
      font-size:14px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
    }

    button.btn{
      background: linear-gradient(180deg, var(--accent2), var(--accent1));
      color:#fff;
      border:none;
      padding:10px 14px;
      border-radius:10px;
      font-weight:600;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s;
      box-shadow: 0 6px 18px rgba(255,111,140,0.18);
    }
    button.btn:active{ transform: translateY(1px) scale(.998); }
    button.btn.ghost{
      background:transparent;
      color:var(--accent1);
      border:1px solid rgba(255,111,140,0.14);
      box-shadow:none;
    }
    button.btn[disabled], .small-btn[disabled]{
      opacity:0.46; cursor:not-allowed; transform:none; box-shadow:none;
    }

    /* Sticks display */
    #sticksWrap{ margin-top:18px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .group {
      display:inline-flex;
      align-items:center;
      padding:8px;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.75), rgba(255,255,255,0.65));
      box-shadow: 0 8px 20px rgba(255,105,145,0.06);
      border:1px solid rgba(255,111,140,0.06);
    }
    .bar {
      width:18px; height:18px; border-radius:6px; margin-right:6px;
      background: linear-gradient(180deg,#ffb7d2,#ff80ab);
      box-shadow: 0 4px 8px rgba(255,111,140,0.18);
      transition: transform .28s cubic-bezier(.2,.95,.17,1), opacity .2s;
    }
    .bar.removed{
      transform: translateY(14px) scale(.6);
      opacity:0;
    }

    .meta{
      display:flex; gap:12px; margin-top:12px; align-items:center; flex-wrap:wrap;
    }
    .pill{
      background:var(--glass); padding:8px 10px; border-radius:999px; font-weight:600; color:var(--accent1);
      border:1px solid rgba(255,111,140,0.06);
    }

    /* Right column: log + actions */
    .side{
      position:relative;
    }
    #log{ min-height:240px; max-height:420px; overflow:auto; background:linear-gradient(180deg, #fff, rgba(255,255,255,0.98)); padding:12px; border-radius:12px; border:1px solid rgba(0,0,0,0.03); }
    .log-entry{ margin-bottom:10px; padding:8px; border-radius:8px; background:linear-gradient(180deg,#fff,#fff); box-shadow: inset 0 -1px 0 rgba(0,0,0,0.02); }
    .log-entry.time{ font-size:12px; color:#777; margin-bottom:6px; }
    .log-entry .who{ font-weight:600; color:var(--accent1); margin-right:8px; }
    .muted{ color:var(--muted); font-size:13px; }

    /* Footer small text */
    .help{ margin-top:10px; color:var(--muted); font-size:13px; }

    /* Responsive */
    @media (max-width:880px){
      .grid{ grid-template-columns: 1fr; }
      .side{ order:-1; margin-bottom:12px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Nim ‚Äî –∏–≥—Ä–∞ —Å–æ —Å–ø–∏—á–∫–∞–º–∏</h1>
      <p>–ò–≥—Ä–æ–∫ —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º. –ë–æ—Ç –∏–≥—Ä–∞–µ—Ç –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∫—Ä–∞—Ç–Ω–æ—Å—Ç–∏ 4. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Äî —Ä–æ–∑–æ–≤—ã–π –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π ‚ú®</p>
    </header>

    <div class="grid">
      <!-- Left: Game -->
      <div class="card">
        <div id="gameHeader">
          <div>
            <div style="font-size:14px; color:var(--muted)">–ù–∞—á–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
            <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
              <input id="init" type="number" value="13" min="1" />
              <button id="start" class="btn">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
              <button id="reset" class="btn ghost" style="display:none;">–ó–∞–Ω–æ–≤–æ</button>
            </div>
          </div>

          <div style="text-align:right;">
            <div style="font-size:13px; color:var(--muted);">–°–µ–π—á–∞—Å</div>
            <div class="pill" id="turnPill">‚Äî</div>
          </div>
        </div>

        <div id="sticksWrap" style="margin-top:18px;">
          <div style="flex-basis:100%">
            <div style="font-size:13px; color:var(--muted)">–ü–æ–ª–µ (—Å–ø–∏—á–∫–∏ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã –ø–æ 4)</div>
            <div id="sticks" style="margin-top:8px;"></div>
          </div>
        </div>

        <div class="meta">
          <div class="pill" id="countPill">–û—Å—Ç–∞–ª–æ—Å—å: ‚Äî</div>
          <div class="pill muted" id="rangePill">–ú–æ–∂–Ω–æ –≤–∑—è—Ç—å: ‚Äî</div>
          <div style="flex:1"></div>
        </div>

        <div style="margin-top:14px;">
          <div id="controls" class="controls-row">
            <button class="btn" data-take="1">–í–∑—è—Ç—å 1</button>
            <button class="btn" data-take="2">–í–∑—è—Ç—å 2</button>
            <button class="btn" data-take="3">–í–∑—è—Ç—å 3</button>
          </div>
          <div class="help">–ö–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª—é—á–∞—é—Ç—Å—è, –µ—Å–ª–∏ —Ö–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.</div>
        </div>
      </div>

      <!-- Right: Log / Info -->
      <div class="side">
        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; font-size:16px;">–•–æ–¥ –∏ –ª–æ–≥</h3>
            <div style="font-size:13px; color:var(--muted)">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤</div>
          </div>

          <div id="log" style="margin-top:12px;"></div>

          <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
            <button id="showState" class="btn ghost">–û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ</button>
            <div style="flex:1"></div>
            <small class="muted">–ü—Ä–æ–µ–∫—Ç –Ω–∞ SWI-Prolog</small>
          </div>
        </div>
      </div>

    </div> <!-- grid -->
  </div> <!-- container -->

  <script>
    // UI logic (–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É, API –∫–∞–∫ —Ä–∞–Ω—å—à–µ: /start, /player_move, /state)
    const startBtn = document.getElementById('start');
    const resetBtn = document.getElementById('reset');
    const initInput = document.getElementById('init');
    const gameDiv = document.querySelector('.card');
    const sticksDiv = document.getElementById('sticks');
    const infoPill = document.getElementById('turnPill');
    const countPill = document.getElementById('countPill');
    const rangePill = document.getElementById('rangePill');
    const logDiv = document.getElementById('log');
    const controls = document.getElementById('controls');

    let currentSticks = 0;
    let currentTurn = null;

    function setTurn(t){
      currentTurn = t;
      infoPill.textContent = (t==='player')? '–í–∞—à —Ö–æ–¥' : (t==='bot'? '–•–æ–¥ –±–æ—Ç–∞' : '‚Äî');
      infoPill.style.background = (t==='player')? 'linear-gradient(90deg,#fff,#fff)' : 'linear-gradient(90deg,#fff,#fff)';
    }

    function setCount(n){
      currentSticks = n;
      countPill.textContent = '–û—Å—Ç–∞–ª–æ—Å—å: ' + n;
      const maxTake = Math.min(3, n);
      rangePill.textContent = '–ú–æ–∂–Ω–æ –≤–∑—è—Ç—å: 1‚Äì' + maxTake;
      // disable buttons if not allowed
      document.querySelectorAll('#controls button').forEach(b=>{
        const take = parseInt(b.dataset.take,10);
        b.disabled = (take > maxTake) || (n === 0) || (currentTurn !== 'player');
      });
    }

    function appendLog(who, text){
      const wrap = document.createElement('div');
      wrap.className = 'log-entry';
      const time = new Date().toLocaleTimeString();
      wrap.innerHTML = '<div class="time">'+time+'</div><div><span class="who">'+who+':</span> <span>'+text+'</span></div>';
      logDiv.prepend(wrap);
    }

    function renderSticks(n, animateTakenCount=0){
      // animateTakenCount: —Å–∫–æ–ª—å–∫–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ —É–±—Ä–∞–Ω–æ (–¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏)
      // —Å–æ–∑–¥–∞—ë–º –≥—Ä—É–ø–ø—ã –ø–æ 4
      sticksDiv.innerHTML = '';
      let rem = n;
      let index = 0;
      while (rem > 0){
        const group = document.createElement('div');
        group.className = 'group';
        const inGroup = Math.min(4, rem);
        for (let i=0;i<inGroup;i++){
          const bar = document.createElement('div');
          bar.className = 'bar';
          // –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∞–Ω–∏–º–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ taken
          if (animateTakenCount>0 && index < animateTakenCount){
            // mark as removed: add class after a microtask so transition occurs
            setTimeout(()=> bar.classList.add('removed'), 40 + (index*40));
            index++;
          }
          group.appendChild(bar);
        }
        sticksDiv.appendChild(group);
        rem -= inGroup;
      }
      if (n===0) sticksDiv.textContent = '[–ø—É—Å—Ç–æ]';
    }

    startBtn.onclick = async () => {
      const sticks = Math.max(1, parseInt(initInput.value) || 13);
      startBtn.disabled = true;
      appendLog('–°–∏—Å—Ç–µ–º–∞','–ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã —Å ' + sticks + ' —Å–ø–∏—á–∫–∞–º–∏...');
      try{
        const res = await fetch('/start', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({sticks})
        });
        const json = await res.json();
        if (!json.ok) { appendLog('–°–∏—Å—Ç–µ–º–∞','–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞: ' + (json.error||'unknown')); startBtn.disabled=false; return; }
        renderSticks(json.sticks);
        setCount(json.sticks);
        setTurn(json.turn);
        appendLog('–°–∏—Å—Ç–µ–º–∞','–ò–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞. –í–∞—à —Ö–æ–¥.');
        startBtn.style.display='none';
        resetBtn.style.display='inline-block';
      }catch(e){
        appendLog('–°–∏—Å—Ç–µ–º–∞','–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message);
        startBtn.disabled=false;
      }
    };

    resetBtn.onclick = () => {
      // –ø—Ä–æ—Å—Ç–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
      window.location.reload();
    };

    document.getElementById('controls').addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('button[data-take]');
      if (!btn) return;
      const take = parseInt(btn.dataset.take,10);
      if (currentTurn !== 'player') { appendLog('–°–∏—Å—Ç–µ–º–∞','–°–µ–π—á–∞—Å –Ω–µ –≤–∞—à —Ö–æ–¥.'); return; }
      // –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
      document.querySelectorAll('#controls button').forEach(b=>b.disabled=true);
      appendLog('–ò–≥—Ä–æ–∫','–ë–µ—Ä—ë—Ç ' + take);
      try{
        const res = await fetch('/player_move', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({take})
        });
        const j = await res.json();
        if (!j.ok) {
          appendLog('–°–∏—Å—Ç–µ–º–∞','–û—à–∏–±–∫–∞: ' + (j.error||'unknown'));
          setCount(currentSticks);
          return;
        }

        if (j.winner === 'player'){
          renderSticks(0, take); // animate taken
          setCount(0);
          setTurn(null);
          appendLog('–ò–≥—Ä–æ–∫','–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏! –ü–æ–∑–¥—Ä–∞–≤–ª—è—é üéâ');
          return;
        }

        // –∏–Ω–∞—á–µ –±–æ—Ç –æ—Ç—ã–≥—Ä–∞–ª –∏–ª–∏ –æ–±–Ω–æ–≤–∏–ª —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        // j contains sticks (new), playerMove, botMove, botExplanation
        renderSticks(j.sticks);
        const botMove = j.botMove;
        const botExp = j.botExplanation || '';
        appendLog('–ë–æ—Ç','–ë–µ—Ä—ë—Ç ' + botMove + (botExp? '. ' + botExp : ''));
        setCount(j.sticks);

        if (j.winner === 'bot'){
          setTurn(null);
          appendLog('–°–∏—Å—Ç–µ–º–∞','–ë–æ—Ç –≤—ã–∏–≥—Ä–∞–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
          return;
        }

        // –µ—Å–ª–∏ –∏–≥—Ä–∞ –Ω–µ –∑–∞–∫–æ–Ω—á–µ–Ω–∞ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ö–æ–¥–∏—Ç
        setTurn('player');
      }catch(err){
        appendLog('–°–∏—Å—Ç–µ–º–∞','–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + err.message);
      } finally {
        // –≤–∫–ª—é—á–∞–µ–º/–≤—ã–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é
        setCount(currentSticks);
      }
    });

    document.getElementById('showState').addEventListener('click', async ()=>{
      try{
        const r = await fetch('/state');
        const j = await r.json();
        if (!j.ok) { appendLog('–°–∏—Å—Ç–µ–º–∞','–ò–≥—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞'); return; }
        renderSticks(j.sticks);
        setCount(j.sticks);
        setTurn(j.turn);
        appendLog('–°–∏—Å—Ç–µ–º–∞','–°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
      }catch(e){ appendLog('–°–∏—Å—Ç–µ–º–∞','–û—à–∏–±–∫–∞: ' + e.message); }
    });

    // initial UI
    renderSticks(0);
    setCount(0);
    setTurn(null);
    appendLog('–°–∏—Å—Ç–µ–º–∞','–ì–æ—Ç–æ–≤–æ. –ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–ø—É—Å—Ç–∏—Ç—å¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.');
  </script>
</body>
</html>
